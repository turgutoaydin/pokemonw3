<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Pok√©dex Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>

  <style>
    :root {
      --red-main: #e02421;
      --red-dark: #a61619;
      --border-dark: #3b0406;
      --screen-bg: #10151f;
      --screen-inner: #05070d;
      --accent-blue: #30a7d7;
      --accent-yellow: #f7d02c;
      --accent-green: #3bd16f;
      --text-soft: rgba(255, 255, 255, 0.78);
      --text-dim: rgba(255, 255, 255, 0.55);
      --radius: 18px;
      --transition-fast: 0.2s ease;
      --transition-med: 0.35s cubic-bezier(.19, 1, .22, 1);
      --shadow-strong: 0 22px 60px rgba(0, 0, 0, 1);
      --card-radius: 14px;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top,
          rgba(255, 255, 255, 0.04),
          transparent 55%)
        ,
        radial-gradient(circle at bottom,
          rgba(0, 0, 0, 0.95),
          #020308);
      color: #fff;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding:
        calc(env(safe-area-inset-top, 0) + 8px)
        8px
        calc(env(safe-area-inset-bottom, 0) + 8px);
      overflow: hidden;
    }

    .pokedex-wrapper {
      width: 100%;
      max-width: 480px;
      height: 100%;
      max-height: 880px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pokedex-device {
      width: 100%;
      height: 100%;
      padding: 10px;
      border-radius: 28px;
      background: linear-gradient(180deg, var(--red-main), var(--red-dark));
      border: 2px solid var(--border-dark);
      box-shadow:
        var(--shadow-strong),
        inset 0 0 16px rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transform-style: preserve-3d;
      transition: transform var(--transition-med),
        box-shadow var(--transition-med);
    }

    .pokedex-device:hover {
      box-shadow:
        0 26px 70px rgba(0, 0, 0, 1),
        inset 0 0 20px rgba(0, 0, 0, 0.9);
    }

    /* HEADER */

    .pokedex-header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .lens-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .lens-outer {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid #fff;
      background: radial-gradient(circle at 30% 30%,
          #ffffff,
          #8be3ff,
          #0064a8);
      box-shadow:
        0 0 10px rgba(255, 255, 255, 0.9),
        0 6px 10px rgba(0, 0, 0, 0.9);
      position: relative;
    }

    .lens-inner {
      position: absolute;
      inset: 9px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%,
          #ffffff,
          #4bbdf0,
          #002b4f);
      opacity: 0.85;
    }

    .lens-lights {
      display: flex;
      gap: 3px;
    }

    .lens-lights .light {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.9);
    }

    .light.red {
      background: #ff4a4a;
    }

    .light.yellow {
      background: #ffd93b;
    }

    .light.green {
      background: #3bd16f;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .label {
      font-size: 8px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .title {
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 0.18em;
      text-shadow: 0 3px 6px rgba(0, 0, 0, 0.9);
    }

    .subtitle {
      font-size: 9px;
      color: var(--text-soft);
    }

    .status-block {
      display: flex;
      justify-content: flex-end;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 8px;
      background: #260508;
      border: 1px solid #5a070a;
      color: var(--accent-yellow);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .chip.small {
      color: var(--accent-blue);
    }

    /* DISPLAY (detay ekran) */

    .display-section {
      flex: 0 0 auto;
    }

    .display-frame {
      margin-top: 2px;
      padding: 4px;
      border-radius: 14px;
      background: #6a0509;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.9);
    }

    .display-inner {
      display: grid;
      grid-template-columns: 1.4fr 2fr;
      gap: 6px;
      padding: 4px;
      border-radius: 10px;
      background: var(--screen-bg);
      border: 1px solid #05070b;
      box-shadow:
        inset 0 0 10px rgba(0, 0, 0, 1),
        0 6px 10px rgba(0, 0, 0, 1);
    }

    .display-sprite {
      border-radius: 6px;
      background: radial-gradient(circle at top,
          #222a3a,
          var(--screen-inner));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }

    .display-sprite img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 1));
    }

    .display-placeholder {
      font-size: 26px;
      color: var(--accent-blue);
      opacity: 0.85;
    }

    .display-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 9px;
      color: var(--text-soft);
    }

    .display-id {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: #070a11;
      border: 1px solid #3a9cff;
      width: fit-content;
    }

    .display-name {
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .display-types {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
    }

    .display-types .type-badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 7px;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 1);
    }

    .display-stats {
      margin-top: 2px;
      line-height: 1.3;
    }

    /* CONTROLS (search + filter) */

    .controls-section {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-top: 2px;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 7px 24px 7px 20px;
      border-radius: 10px;
      border: 1px solid #4f0609;
      background: #160408;
      color: #fff;
      font-size: 9px;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 1);
      outline: none;
      transition: all var(--transition-fast);
    }

    .search-input::placeholder {
      color: var(--text-dim);
    }

    .search-input:focus {
      border-color: var(--accent-blue);
      box-shadow:
        0 0 0 1px rgba(48, 167, 215, 0.4),
        0 6px 12px rgba(0, 0, 0, 1);
    }

    .search-icon {
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 9px;
      opacity: 0.7;
    }

    .clear-search {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: #111;
      font-size: 9px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .filters {
      display: flex;
      gap: 3px;
      overflow-x: auto;
      padding-bottom: 1px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .filters::-webkit-scrollbar {
      display: none;
    }

    .filter-btn {
      padding: 3px 6px;
      font-size: 7px;
      border-radius: 999px;
      border: 1px solid #4f0609;
      background: #1a0508;
      color: var(--text-dim);
      white-space: nowrap;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--accent-blue), #1e7fa8);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 1);
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chip select {
      background: transparent;
      border: none;
      color: var(--accent-yellow);
      font-size: 8px;
      outline: none;
    }

    /* TABS */

    .tabs {
      display: flex;
      gap: 4px;
      margin-top: 2px;
    }

    .tab-btn {
      flex: 1;
      padding: 4px 0;
      font-size: 8px;
      border-radius: 8px;
      border: 1px solid #4f0609;
      background: #1a0508;
      color: var(--text-dim);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .tab-btn.active {
      background: #0b0b0f;
      color: var(--accent-yellow);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 1);
    }

    /* LIST */

    .list-section {
      flex: 1;
      margin-top: 1px;
      padding: 4px;
      border-radius: 14px;
      background: #1a0508;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 1);
    }

    .pokemon-list {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-right: 2px;
      font-size: 9px;
      scrollbar-width: thin;
      scrollbar-color: #6b0b0e transparent;
    }

    .pokemon-list::-webkit-scrollbar {
      width: 3px;
    }

    .pokemon-list::-webkit-scrollbar-thumb {
      background: #6b0b0e;
      border-radius: 999px;
    }

    .pokemon-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 6px;
      border-radius: var(--card-radius);
      background: linear-gradient(135deg, #200408, #36060a);
      border: 1px solid #4f0609;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 1);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .pokemon-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 14px rgba(0, 0, 0, 1);
      border-color: var(--accent-blue);
    }

    .sprite-wrap {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: #08090d;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 1);
    }

    .sprite-wrap img {
      width: 30px;
      height: 30px;
      object-fit: contain;
      filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 1));
    }

    .info-block {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .info-top {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .pokemon-id {
      padding: 1px 4px;
      font-size: 7px;
      border-radius: 8px;
      background: #06070b;
      border: 1px solid #5a070a;
    }

    .pokemon-name {
      font-size: 10px;
      font-weight: 700;
      text-transform: capitalize;
    }

    .quick-stats {
      font-size: 7px;
      color: var(--text-dim);
    }

    .pokemon-types {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
    }

    .pokemon-types .type-badge {
      padding: 1px 4px;
      font-size: 6px;
      border-radius: 999px;
      color: #fff;
    }

    .favorite-toggle {
      position: absolute;
      top: 3px;
      right: 4px;
      width: 13px;
      height: 13px;
      border-radius: 4px;
      background: #150307;
      border: 1px solid #5a070a;
      color: var(--text-dim);
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .favorite-toggle.active {
      background: #ffd700;
      color: #111;
      border-color: #111;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 1);
    }

    .loading,
    .no-results {
      text-align: center;
      padding: 18px 6px;
      font-size: 9px;
      color: var(--text-soft);
    }

    .loading-spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.16);
      border-top-color: var(--accent-blue);
      margin: 0 auto 6px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* FOOTER */

    .pokedex-footer {
      margin-top: 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .dpad {
      position: relative;
      width: 26px;
      height: 26px;
    }

    .dpad .btn {
      position: absolute;
      background: #0b0b0f;
      border-radius: 3px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 1);
    }

    .dpad .center {
      width: 8px;
      height: 8px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .dpad .up {
      width: 7px;
      height: 7px;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .dpad .down {
      width: 7px;
      height: 7px;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .dpad .left {
      width: 7px;
      height: 7px;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    .dpad .right {
      width: 7px;
      height: 7px;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    .ab-btn {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #0b0b0f;
      color: #eee;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 1);
    }

    .controls-right {
      display: flex;
      gap: 4px;
    }

    .random-btn {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,
          var(--accent-blue),
          #1b6b8f);
      color: #fff;
      font-size: 9px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 1);
      transition: all var(--transition-fast);
    }

    .random-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 1);
    }

    @media (max-width: 480px) {
      .pokedex-device {
        border-radius: 24px;
      }

      .title {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
<div class="pokedex-wrapper">
  <div class="pokedex-device">
    <!-- HEADER -->
    <header class="pokedex-header">
      <div class="lens-block">
        <div class="lens-outer">
          <div class="lens-inner"></div>
        </div>
        <div class="lens-lights">
          <span class="light red"></span>
          <span class="light yellow"></span>
          <span class="light green"></span>
        </div>
      </div>
      <div class="title-block">
        <div class="label">KANTO TECH ¬∑ POK√â-TERMINAL</div>
        <div class="title">POK√âDEX</div>
        <div class="subtitle">Telegram Mini ¬∑ Dokunmatik Aray√ºz</div>
      </div>
      <div class="status-block">
        <div class="chip" id="totalCount">Y√ºkleniyor...</div>
      </div>
    </header>

    <!-- DISPLAY -->
    <section class="display-section">
      <div class="display-frame">
        <div class="display-inner">
          <div class="display-sprite" id="detailSprite">
            <span class="display-placeholder">‚óì</span>
          </div>
          <div class="display-info">
            <div class="display-id" id="detailId">#---</div>
            <div class="display-name" id="detailName">Bir Pok√©mon se√ß</div>
            <div class="display-types" id="detailTypes"></div>
            <div class="display-stats" id="detailStats">
              A≈üaƒüƒ±daki listeden bir Pok√©mon'a dokunarak detaylarƒ± g√∂r.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SEARCH + FILTERS -->
    <section class="controls-section">
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input
          id="searchInput"
          class="search-input"
          type="text"
          placeholder="ƒ∞sim veya #ID ara (√∂rn: pikachu, 025)"
        />
        <button id="clearSearch" class="clear-search">√ó</button>
      </div>
      <div class="filters" id="filters">
        <button class="filter-btn active" data-filter="all">T√ºm√º</button>
        <button class="filter-btn" data-filter="generation-1">Gen 1</button>
        <button class="filter-btn" data-filter="generation-2">Gen 2</button>
        <button class="filter-btn" data-filter="generation-3">Gen 3</button>
        <button class="filter-btn" data-filter="legendary">Efsanevi</button>
        <button class="filter-btn" data-filter="starter">Starter</button>
      </div>
      <div class="controls-row">
        <div class="chip">
          Sƒ±rala:
          <select id="sortSelect">
            <option value="id-asc">ID ‚Üë</option>
            <option value="id-desc">ID ‚Üì</option>
            <option value="name-asc">Ada g√∂re</option>
          </select>
        </div>
        <div class="chip small">RUN</div>
      </div>
    </section>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="dex">DEX</button>
      <button class="tab-btn" data-tab="favorites">‚òÖ FAVORƒ∞LER</button>
    </div>

    <!-- LIST -->
    <section class="list-section">
      <div class="pokemon-list" id="pokemonList">
        <div class="loading">
          <div class="loading-spinner"></div>
          Pok√©mon'lar y√ºkleniyor...
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="pokedex-footer">
      <div class="controls-left">
        <div class="dpad">
          <span class="btn up"></span>
          <span class="btn left"></span>
          <span class="btn center"></span>
          <span class="btn right"></span>
          <span class="btn down"></span>
        </div>
      </div>
      <button class="random-btn" id="randomBtn">
        üé≤ Rastgele Pok√©mon
      </button>
      <div class="controls-right">
        <div class="ab-btn a">A</div>
        <div class="ab-btn b">B</div>
      </div>
    </footer>
  </div>
</div>

<script>
  // --- API yardƒ±mcƒ±larƒ± ---
  const POKEMON_API = 'https://pokeapi.co/api/v2';
  const pokemonCache = {};

  async function fetchPokemon(nameOrId) {
    const key = String(nameOrId).toLowerCase();
    if (pokemonCache[key]) return pokemonCache[key];

    try {
      const res = await fetch(\`\${POKEMON_API}/pokemon/\${key}\`);
      if (!res.ok) return null;
      const data = await res.json();
      pokemonCache[data.name] = data;
      pokemonCache[String(data.id)] = data;
      return data;
    } catch (e) {
      console.error('fetchPokemon error', e);
      return null;
    }
  }

  function getIdFromUrl(url) {
    const parts = url.split('/').filter(Boolean);
    return parts[parts.length - 1];
  }

  function getTypeColor(type) {
    const colors = {
      normal: 40, fire: 18, water: 210, grass: 120, electric: 52, ice: 190,
      fighting: 10, poison: 285, ground: 32, flying: 220, psychic: 320,
      bug: 100, rock: 30, ghost: 260, dragon: 260, dark: 260, steel: 220,
      fairy: 330
    };
    return colors[type] || 0;
  }

  function getStatName(stat) {
    const map = {
      hp: 'HP',
      attack: 'Saldƒ±rƒ±',
      defense: 'Savunma',
      'special-attack': '√ñzel Saldƒ±rƒ±',
      'special-defense': '√ñzel Savunma',
      speed: 'Hƒ±z'
    };
    return map[stat] || stat;
  }

  function calculateWeaknesses(types) {
    const table = {
      fire: ['water','rock','ground'],
      water: ['electric','grass'],
      grass: ['fire','ice','poison','flying','bug'],
      electric: ['ground'],
      rock: ['water','grass','fighting','ground','steel'],
      ground: ['water','grass','ice'],
      flying: ['electric','ice','rock'],
      psychic: ['bug','ghost','dark'],
      dark: ['fighting','bug','fairy'],
      fighting: ['flying','psychic','fairy'],
      ice: ['fire','fighting','rock','steel'],
      dragon: ['ice','dragon','fairy'],
      bug: ['fire','flying','rock'],
      ghost: ['ghost','dark'],
      steel: ['fire','fighting','ground'],
      fairy: ['poison','steel'],
      poison: ['ground','psychic']
    };
    const weak = new Set();
    types.forEach(t => (table[t] || []).forEach(w => weak.add(w)));
    return [...weak];
  }

  // --- MAIN ---

  document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram && window.Telegram.WebApp
      ? window.Telegram.WebApp
      : null;

    if (tg) {
      tg.ready();
      tg.expand();
      try { tg.enableVerticalSwipes(); } catch (e) {}
    }

    const device = document.querySelector('.pokedex-device');
    const totalCountEl = document.getElementById('totalCount');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    const filtersEl = document.getElementById('filters');
    const sortSelect = document.getElementById('sortSelect');
    const tabs = document.querySelectorAll('.tab-btn');
    const listEl = document.getElementById('pokemonList');
    const randomBtn = document.getElementById('randomBtn');

    const detailSprite = document.getElementById('detailSprite');
    const detailId = document.getElementById('detailId');
    const detailName = document.getElementById('detailName');
    const detailTypes = document.getElementById('detailTypes');
    const detailStats = document.getElementById('detailStats');

    // hafif 3D
    device.addEventListener('pointermove', (e) => {
      const rect = device.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;
      const rx = y * -3;
      const ry = x * 3;
      device.style.transform = \`rotateX(\${rx}deg) rotateY(\${ry}deg)\`;
    });
    device.addEventListener('pointerleave', () => {
      device.style.transform = 'rotateX(0deg) rotateY(0deg)';
    });

    // state
    let allPokemon = [];
    let filteredPokemon = [];
    let currentTab = 'dex';
    let favorites = new Set(
      JSON.parse(localStorage.getItem('pokedex_favorites') || '[]')
    );
    let legendarySet = null;
    const startersSet = new Set([
      'bulbasaur','ivysaur','venusaur',
      'charmander','charmeleon','charizard',
      'squirtle','wartortle','blastoise',
      'chikorita','bayleef','meganium',
      'cyndaquil','quilava','typhlosion',
      'totodile','croconaw','feraligatr'
    ]);

    const CHUNK_SIZE = 40;
    let currentRendered = 0;
    let isAppending = false;

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function debounce(fn, ms) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    function isFavorite(id) {
      return favorites.has(String(id));
    }

    function saveFavorites() {
      localStorage.setItem(
        'pokedex_favorites',
        JSON.stringify([...favorites])
      );
    }

    function toggleFavorite(id, event) {
      if (event) event.stopPropagation();
      const key = String(id);
      if (favorites.has(key)) {
        favorites.delete(key);
        if (tg) tg.HapticFeedback.impactOccurred('light');
      } else {
        favorites.add(key);
        if (tg) tg.HapticFeedback.notificationOccurred('success');
      }
      saveFavorites();
      updateFavoriteIcons();
      if (currentTab === 'favorites') applyFilters();
    }
    window.toggleFavorite = toggleFavorite;

    function updateFavoriteIcons() {
      document.querySelectorAll('.pokemon-card').forEach((card) => {
        const id = card.getAttribute('data-id');
        const fav = card.querySelector('.favorite-toggle');
        if (!fav || !id) return;
        if (isFavorite(id)) {
          fav.classList.add('active');
          fav.textContent = '‚òÖ';
        } else {
          fav.classList.remove('active');
          fav.textContent = '‚òÜ';
        }
      });
    }

    async function loadAllPokemon() {
      try {
        const res = await fetch(\`\${POKEMON_API}/pokemon?limit=1328\`);
        const data = await res.json();
        allPokemon = data.results;
        filteredPokemon = [...allPokemon];
        totalCountEl.textContent = \`Toplam \${data.count} Pok√©mon\`;
        sortCurrent();
        renderList(filteredPokemon, true);
        if (tg) tg.HapticFeedback.impactOccurred('medium');
      } catch (e) {
        console.error(e);
        listEl.innerHTML =
          '<div class="no-results">Y√ºklenemedi. Yeniden dene.</div>';
      }
    }

    function buildCard(p) {
      const id = getIdFromUrl(p.url);
      const card = document.createElement('div');
      card.className = 'pokemon-card';
      card.dataset.id = id;
      card.onclick = () => showDetail(p.name);

      card.innerHTML = `
        <div class="sprite-wrap">
          <img
            src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/${id}.png"
            onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png'"
            alt="${p.name}"
          />
        </div>
        <div class="info-block">
          <div class="info-top">
            <div class="pokemon-id">#${id.toString().padStart(3, '0')}</div>
            <div class="pokemon-name">${capitalize(p.name)}</div>
          </div>
          <div class="quick-stats" id="quick-${id}">Y√ºkleniyor...</div>
          <div class="pokemon-types" id="types-${id}"></div>
        </div>
        <div class="favorite-toggle ${
          isFavorite(id) ? 'active' : ''
        }" onclick="toggleFavorite('${id}', event)">
          ${isFavorite(id) ? '‚òÖ' : '‚òÜ'}
        </div>
      `;

      loadMiniData(p.name, id);
      return card;
    }

    async function loadMiniData(name, id) {
      const pokemon = await fetchPokemon(name);
      const typesEl = document.getElementById(`types-${id}`);
      const quickEl = document.getElementById(`quick-${id}`);
      if (!pokemon) {
        if (quickEl) quickEl.textContent = '';
        return;
      }

      if (typesEl) {
        typesEl.innerHTML = pokemon.types
          .map(
            (t) => `
          <span class="type-badge"
                style="background:hsl(${getTypeColor(
                  t.type.name
                )},70%,45%);">
            ${capitalize(t.type.name)}
          </span>`
          )
          .join('');
      }

      if (quickEl) {
        const hp =
          pokemon.stats.find((s) => s.stat.name === 'hp')?.base_stat ?? '?';
        const spd =
          pokemon.stats.find((s) => s.stat.name === 'speed')?.base_stat ??
          '?';
        quickEl.textContent = `HP ${hp} ¬∑ Hƒ±z ${spd}`;
      }
    }

    function renderList(pokemons, reset = true) {
      if (reset) {
        listEl.innerHTML = '';
        currentRendered = 0;
      }
      if (!pokemons.length) {
        listEl.innerHTML =
          '<div class="no-results">Sonu√ß yok.</div>';
        return;
      }
      appendChunk(pokemons);
    }

    function appendChunk(pokemons) {
      if (isAppending) return;
      if (currentRendered >= pokemons.length) return;
      isAppending = true;

      const fragment = document.createDocumentFragment();
      const slice = pokemons.slice(
        currentRendered,
        currentRendered + CHUNK_SIZE
      );
      slice.forEach((p) => fragment.appendChild(buildCard(p)));

      listEl.appendChild(fragment);
      currentRendered += slice.length;
      isAppending = false;
    }

    listEl.addEventListener('scroll', () => {
      if (
        listEl.scrollTop + listEl.clientHeight >=
        listEl.scrollHeight - 120
      ) {
        appendChunk(filteredPokemon);
      }
    });

    async function showDetail(name) {
      if (tg) tg.HapticFeedback.impactOccurred('light');
      const pokemon = await fetchPokemon(name);
      if (!pokemon) return;

      const id = pokemon.id;

      detailSprite.innerHTML = `
        <img src="${
          pokemon.sprites.other?.['official-artwork']?.front_default ||
          pokemon.sprites.other?.home?.front_default ||
          pokemon.sprites.front_default ||
          ''
        }" alt="${name}" />
      `;

      detailId.textContent = `#${String(id).padStart(3, '0')}`;
      detailName.textContent = capitalize(name);

      detailTypes.innerHTML = pokemon.types
        .map(
          (t) => `
        <span class="type-badge"
              style="background:hsl(${getTypeColor(
                t.type.name
              )},70%,45%);">
          ${capitalize(t.type.name)}
        </span>`
        )
        .join('');

      const statsLines = pokemon.stats.map(
        (stat) =>
          `${getStatName(stat.stat.name)}: ${stat.base_stat}`
      );

      const weaknesses = calculateWeaknesses(
        pokemon.types.map((t) => t.type.name)
      );

      const weakLine = weaknesses.length
        ? `Zayƒ±flƒ±klar: ${weaknesses
            .map((w) => capitalize(w))
            .join(', ')}`
        : 'Belirgin zayƒ±flƒ±k yok.';

      detailStats.innerHTML = `
        ${statsLines.join(' ¬∑ ')}<br />
        <span style="color: var(--accent-yellow)">${weakLine}</span>
      `;
    }

    function sortCurrent() {
      const val = sortSelect.value;
      filteredPokemon.sort((a, b) => {
        const idA = Number(getIdFromUrl(a.url));
        const idB = Number(getIdFromUrl(b.url));
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        if (val === 'id-asc') return idA - idB;
        if (val === 'id-desc') return idB - idA;
        if (val === 'name-asc') return nameA.localeCompare(nameB);
        return idA - idB;
      });
    }

    async function applyFilters() {
      if (!allPokemon.length) return;
      let list = [...allPokemon];

      // tab
      if (currentTab === 'favorites') {
        list = list.filter((p) =>
          favorites.has(getIdFromUrl(p.url))
        );
      }

      // filter buttons
      const activeFilter =
        document.querySelector('.filter-btn.active')
          ?.dataset.filter || 'all';

      if (activeFilter.startsWith('generation-')) {
        const ranges = {
          'generation-1': [1, 151],
          'generation-2': [152, 251],
          'generation-3': [252, 386]
        };
        const [min, max] =
          ranges[activeFilter] || [1, 1328];
        list = list.filter((p) => {
          const id = Number(getIdFromUrl(p.url));
          return id >= min && id <= max;
        });
      } else if (activeFilter === 'legendary') {
        if (!legendarySet) {
          try {
            const res = await fetch(
              \`\${POKEMON_API}/pokemon-species?limit=2000\`
            );
            const data = await res.json();
            const detailed = await Promise.all(
              data.results.map((r) =>
                fetch(r.url)
                  .then((x) => x.json())
                  .catch(() => null)
              )
            );
            legendarySet = new Set(
              detailed
                .filter(
                  (s) =>
                    s &&
                    (s.is_legendary || s.is_mythical)
                )
                .map((s) => s.name)
            );
          } catch (e) {
            console.error('Legendary fetch error', e);
            legendarySet = new Set();
          }
        }
        list = list.filter((p) =>
          legendarySet.has(p.name)
        );
      } else if (activeFilter === 'starter') {
        list = list.filter((p) =>
          startersSet.has(p.name)
        );
      }

      // search
      const q = searchInput.value.trim().toLowerCase();
      if (q) {
        list = list.filter((p) => {
          const name = p.name.toLowerCase();
          const id = getIdFromUrl(p.url);
          return (
            name.includes(q) ||
            id.startsWith(q.replace('#', ''))
          );
        });
      }

      filteredPokemon = list;
      sortCurrent();
      renderList(filteredPokemon, true);
      updateFavoriteIcons();
    }

    // events

    searchInput.addEventListener(
      'input',
      debounce(() => {
        const v = searchInput.value.trim();
        clearSearchBtn.style.display = v
          ? 'flex'
          : 'none';
        applyFilters();
      }, 220)
    );

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      clearSearchBtn.style.display = 'none';
      applyFilters();
    });

    filtersEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-btn');
      if (!btn) return;
      document
        .querySelectorAll('.filter-btn')
        .forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    });

    sortSelect.addEventListener('change', () => {
      sortCurrent();
      renderList(filteredPokemon, true);
      updateFavoriteIcons();
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        tabs.forEach((t) =>
          t.classList.remove('active')
        );
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        applyFilters();
      });
    });

    randomBtn.addEventListener('click', () => {
      if (!allPokemon.length) return;
      const pool =
        currentTab === 'favorites'
          ? allPokemon.filter((p) =>
              favorites.has(getIdFromUrl(p.url))
            )
          : allPokemon;
      if (!pool.length) return;
      const random =
        pool[Math.floor(Math.random() * pool.length)];
      showDetail(random.name);
    });

    // start
    loadAllPokemon();
  });
</script>
</body>
</html>